name: PR Check

# PRì´ ìƒì„±ë˜ê±°ë‚˜ ì—…ë°ì´íŠ¸ë  ë•Œ ì‹¤í–‰
on:
  pull_request:
    branches:
      - main
      - develop
    types: [opened, synchronize, reopened]

jobs:
  lint-and-test:
    name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: JavaScript Lint ê²€ì‚¬
        run: npm run lint:js
        continue-on-error: false

      - name: CSS Lint ê²€ì‚¬
        run: npm run lint:css
        continue-on-error: false

      - name: ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬
        run: npx prettier --check 'src/**/*.{js,css,html}'
        continue-on-error: false

      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: npm test
        continue-on-error: false

      - name: ë¹Œë“œ ê²€ì¦
        run: npm run build

      - name: PRì— ê²€ì‚¬ ê²°ê³¼ ì½”ë©˜íŠ¸
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const message = `## âœ… ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì™„ë£Œ
            
            - JavaScript Lint: í†µê³¼
            - CSS Lint: í†µê³¼
            - ì½”ë“œ í¬ë§·íŒ…: í†µê³¼
            - ë¹Œë“œ: ì„±ê³µ
            
            PRì´ ë³‘í•© ê°€ëŠ¥í•©ë‹ˆë‹¤! ğŸ‰`;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });

  security-check:
    name: ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: npm audit ì‹¤í–‰
        run: npm audit --audit-level=moderate
        continue-on-error: true

  code-review:
    name: ìë™ ì½”ë“œ ë¦¬ë·°
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ë³€ê²½ëœ íŒŒì¼ í™•ì¸
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            src/**/*.js
            src/**/*.css
            src/**/*.html

      - name: ì½”ë“œ ë¦¬ë·° ì½”ë©˜íŠ¸ ì¶”ê°€
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const changedFiles = `${{ steps.changed-files.outputs.all_changed_files }}`.split(' ');
            
            let message = `## ğŸ“ ìë™ ì½”ë“œ ë¦¬ë·°\n\n`;
            message += `**ë³€ê²½ëœ íŒŒì¼:** ${changedFiles.length}ê°œ\n\n`;
            message += `### ë³€ê²½ íŒŒì¼ ëª©ë¡:\n`;
            
            changedFiles.forEach(file => {
              message += `- \`${file}\`\n`;
            });
            
            message += `\n### ì²´í¬ë¦¬ìŠ¤íŠ¸:\n`;
            message += `- [ ] ì½”ë“œì— ì ì ˆí•œ ì£¼ì„ì´ ìˆë‚˜ìš”?\n`;
            message += `- [ ] ì—ëŸ¬ í•¸ë“¤ë§ì´ ì ì ˆí•œê°€ìš”?\n`;
            message += `- [ ] ì‚¬ìš©ì ê²½í—˜ì´ ê°œì„ ë˜ì—ˆë‚˜ìš”?\n`;
            message += `- [ ] kintone API ì‚¬ìš©ì´ ì˜¬ë°”ë¥¸ê°€ìš”?\n`;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
